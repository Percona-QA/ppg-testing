---
- name: Prepare node for running tests
  hosts: all
  become: true
  become_method: sudo
  gather_facts: true
  tasks:
    - name: setup ca-certificates release
      yum:
        name: ca-certificates
        update_cache: yes
        state: present
      when: ansible_os_family == "RedHat"

    - name: Enable epel-release on Rhel8 systems using Fedora epel rpm
      become: true
      command: dnf -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm
      when: ansible_os_family == "RedHat" and ansible_distribution_major_version == "8"

    - name: Enable epel-release on Rhel9 systems using Fedora epel rpm
      become: true
      command: dnf -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm
      when: ansible_os_family == "RedHat" and ansible_distribution_major_version == "9"

    - name: Enable epel-release on Rhel10 systems using Fedora epel rpm
      become: true
      command: dnf -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-10.noarch.rpm
      when: ansible_os_family == "RedHat" and ansible_distribution_major_version == "10"

    - name: Disable subscription message on RHEL OS
      become: true
      command: sudo sed -i 's/enabled[ ]*=[ ]*1/enabled=0/g' /etc/dnf/plugins/subscription-manager.conf
      when: ansible_os_family == "RedHat" and ansible_distribution == "RedHat"

    - name: setup epel release
      yum:
        name: epel-release
        update_cache: yes
        state: present
      when: ansible_os_family == "RedHat" and ansible_distribution != "RedHat"

    - name: Update /etc/apt/sources.list on Debian 11
      become: true
      command: sudo sed -i 's/cdn-aws\.deb/archive/g' /etc/apt/sources.list
      when: ansible_os_family == "Debian" and ansible_distribution_major_version == "11"

    - name: install needed packages for running tests with apt
      apt:
        name: "{{ packages }}"
        update_cache: yes
        state: latest
      vars:
        packages:
          - unzip
          - wget
          - gnupg
          - gnupg2
          - rsync
          - acl
          - git
      retries: 60
      delay: 10
      register: result
      until: result is not failed
      when: ansible_os_family == "Debian"

    - name: update systemd-sysv integration on debian/ubuntu
      apt:
        name: "{{ packages }}"
        update_cache: yes
        state: latest
      vars:
        packages:
        - systemd-sysv
      when: ansible_os_family == "Debian" and ansible_distribution_release != "trusty"

    - name: install needed packages for running tests with yum
      yum:
        name: "{{ packages }}"
        state: latest
      vars:
        packages:
          - pv
          - libselinux-python
          - unzip
          - wget
          - rsync
          - git-all
      when: ansible_os_family == "RedHat" and ansible_distribution_major_version|int <= 7

    - name: install needed packages for running tests with yum on RHEL8
      yum:
        name: "{{ packages }}"
        state: latest
      vars:
        packages:
        - unzip
        - wget
        - git-all
      when: ansible_os_family == "RedHat" and ansible_distribution_major_version|int == 8

    - name: Update RedHat-family systems to latest
      become: true
      ansible.builtin.shell: dnf update -y
      when: ansible_os_family == "RedHat"

    - name: Enable Powertools on Rocky 8
      become: true
      shell: | 
        dnf install -y dnf-plugins-core
        dnf config-manager --set-enabled powertools
      when: ansible_distribution == "Rocky" and ansible_distribution_major_version == "8"

    - name: Enable CRB on rocky linux 9 and 10
      become: true
      shell: | 
        dnf install -y dnf-plugins-core
        dnf config-manager --set-enabled crb
      when: ansible_os_family == "RedHat" and ansible_distribution == "Rocky" and
        (ansible_distribution_major_version == "9" or ansible_distribution_major_version == "10")

    - name: Enable ol8_codeready_builder on Oracle Linux 8
      become: true
      shell: | 
        dnf install -y dnf-plugins-core
        dnf config-manager --set-enabled ol8_codeready_builder
      when: ansible_distribution == "OracleLinux" and ansible_distribution_major_version == "8"

    - name: Enable ol9_codeready_builder on Oracle Linux 9
      become: true
      shell: | 
        dnf install -y dnf-plugins-core
        dnf config-manager --set-enabled ol9_codeready_builder
      when: ansible_distribution == "OracleLinux" and ansible_distribution_major_version == "9"

    - name: Enable codeready-builder for RHEL 8
      become: true
      shell: | 
        dnf install -y dnf-plugins-core
        dnf config-manager --set-enabled codeready-builder-for-rhel-8-rhui-rpms
      when: ansible_os_family == "RedHat" and ansible_distribution == "RedHat" and ansible_distribution_major_version == "8"

    - name: Enable codeready-builder for RHEL 9
      become: true
      shell: | 
        dnf install -y dnf-plugins-core
        dnf config-manager --set-enabled codeready-builder-for-rhel-9-rhui-rpms
      when: ansible_os_family == "RedHat" and ansible_distribution == "RedHat" and ansible_distribution_major_version == "9"

    - name: Enable CodeReady Builder on RHEL 10
      become: true
      block:
        - name: Install dnf plugins
          ansible.builtin.dnf:
            name: dnf-plugins-core
            state: present

        - name: Enable CodeReady Builder repo
          ansible.builtin.command:
            cmd: dnf config-manager --set-enabled codeready-builder-for-rhel-10-rhui-rpms
      when:
        - ansible_distribution == "RedHat"
        - ansible_distribution_major_version | int == 10

    - name: install acl package on rhel 10
      become: true
      command:  sudo dnf install -y acl
      when: ansible_os_family == "RedHat" and ansible_distribution_major_version == "10"

    - name: Setup oracle linux 9 for ssh
      become: true
      shell: | 
        setenforce 0
        firewall-cmd --permanent --add-service=ssh
        firewall-cmd --reload
        systemctl enable sshd
        systemctl start sshd
      when: ansible_distribution == "OracleLinux" and ansible_distribution_major_version == "9"

    - name: Install additional packages RPM
      yum:
        name: "{{ packages }}"
        state: latest
        update_cache: yes
      vars:
        packages:
          - openssl-devel
          - readline-devel
          - openssl
          - gcc
          - gcc-c++
          - libevent-devel
          - perl-Pod-Checker
          - perl-devel
          - perl-JSON-XS
          - perl-Test-Simple
          - perl-IPC-Run
          - libtool
          - make
          - pandoc
          - pkgconfig
      when: ansible_os_family == "RedHat"

    # - name: Install additional packages RPM
    #   yum:
    #     name: "{{ packages }}"
    #     state: latest
    #     update_cache: yes
    #   vars:
    #     packages:
    #       - openssl-devel
    #       - readline-devel
    #       - openssl
    #       - gcc
    #       - gcc-c++
    #       - libevent-devel
    #       - perl-Pod-Checker
    #       - perl-devel
    #       - perl-JSON-XS
    #       - perl-Test-Simple
    #       - libtool
    #       - make
    #       - pandoc
    #       - pkgconfig
    #   when: ansible_os_family == "RedHat"

    # - name: Install Perl JSON module for EL10+
    #   yum:
    #     name: perl-JSON
    #     state: present
    #   when:
    #     - ansible_os_family == "RedHat"
    #     - ansible_distribution_major_version|int >= 10

    # - name: Install Perl JSON::XS for EL7â€“9
    #   yum:
    #     name: perl-JSON-XS
    #     state: present
    #   when:
    #     - ansible_os_family == "RedHat"
    #     - ansible_distribution_major_version|int < 10

    - name: Install additional packages Debian
      apt:
        name: "{{ packages }}"
        state: latest
        update_cache: yes
      vars:
        packages:
          - libtool
          - libevent-dev
          - m4
          - automake
          - pkg-config
          - libssl-dev
          - libreadline-dev
          - build-essential
          - pandoc
      when: ansible_os_family == "Debian"

    - name: Setup SSH keys CentOS
      ansible.posix.authorized_key:
        user: centos
        key: "{{ lookup('file', 'public_keys') }}"
        state: present
        exclusive: False
      when: ansible_distribution == "CentOS"

    - name: Setup SSH keys for Oracle Linux or Amazon
      ansible.posix.authorized_key:
        user: ec2-user
        key: "{{ lookup('file', 'public_keys') }}"
        state: present
        exclusive: False
      when: ansible_distribution == "OracleLinux" and ansible_distribution_major_version|int == 8

    - name: Setup SSH keys for Rocky Linux or Amazon
      ansible.posix.authorized_key:
        user: rocky
        key: "{{ lookup('file', 'public_keys') }}"
        state: present
        exclusive: False
      when: ansible_distribution == "Rocky"

    - name: Setup SSH keys Debian
      ansible.posix.authorized_key:
        user: admin
        key: "{{ lookup('file', 'public_keys') }}"
        state: present
        exclusive: False
      when: ansible_distribution == "Debian"

    - name: Setup SSH keys Ubuntu
      ansible.posix.authorized_key:
        user: ubuntu
        key: "{{ lookup('file', 'public_keys') }}"
        state: present
        exclusive: False
      when: ansible_distribution == "Ubuntu"
